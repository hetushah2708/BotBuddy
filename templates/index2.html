<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buddy</title>
  <link rel="shortcut icon" href="/static/assets/image/Icon_1.ico" type="image/x-icon" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <!-- Particle.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>

  <!-- Texllate -->
  <link rel="stylesheet" href="/static/assets/vendore/texllate/animate.css">
  <link rel="stylesheet" href="/static/style.css">

  <!-- Recorder.js -->
    <script src="{{ url_for('static', filename='recorder.js') }}"></script>
</head>

<body>
  <!-- Chatbot Visual + Recording Section -->
  <section id="Oval" class="mb-4">
    <div class="mycontainer" style="height: 100vh;">
      <canvas id="canvasOne" width="500" height="500"></canvas>
      <div id="BuddyHood">
        <div class="square">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
<div class="project-text">
      <h5 class="text-light mt-4" style="z-index: 2; text-align: center;">Ask me anything</h5>

      <!-- Buttons + Text -->
      <div class="text-center text-light mt-3" style="z-index: 2;">
        <h5>Record, Send and Process</h5>
        <button id="startBtn">Start Listening (Server)</button>
        <button id="stopBtn" style="display:inline;">Stop</button>

        <p><strong>Original Text:</strong> <span id="originalText"></span></p>
        <p><strong>Processed Text:</strong> <span id="processedText"></span></p>
      </div>
      </div>
    </div>
  </section>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <script src="/static/assets/vendore/texllate/jquery.fittext.js"></script>
  <script src="/static/assets/vendore/texllate/jquery.lettering.js"></script>
  <script src="http://jschr.github.io/textillate/jquery.textillate.js"></script>

  <script src="static/script.js"></script>
  <script src="static/main.js"></script>
  <script src="/eel.js"></script>

    <script>
    let keepListening = false;
    let speaking = false;

    async function listenLoop() {
        if (!keepListening) return;
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        startBtn.disabled = true;
        stopBtn.disabled = false;
        startBtn.textContent = 'Listening... (Speak into server mic)';
        try {
            const response = await fetch('/start-listening', { method: 'POST' });
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            const data = await response.json();
            if (data.error) {
                alert('Error: ' + data.error);
                keepListening = false;
            } else {
                document.getElementById('originalText').textContent = data.original;
                document.getElementById('processedText').textContent = data.processed;
                // Text-to-Speech for processed output
                if (data.processed) {
                    await speakText(data.processed);
                }
            }
        } catch (error) {
            alert('Error: ' + error.message);
            keepListening = false;
        } finally {
            startBtn.disabled = keepListening;
            stopBtn.disabled = !keepListening;
            startBtn.textContent = keepListening ? 'Listening... (Speak into server mic)' : 'Start Listening (Server)';
            // Add a longer delay to avoid rapid-fire requests
            if (keepListening && !speaking) {
                setTimeout(listenLoop, 1500); // 1.5 seconds delay
            }
        }
    }

    function speakText(text) {
        return new Promise((resolve) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                utter.rate = 1;
                utter.pitch = 1;
                speaking = true;
                utter.onend = () => {
                    speaking = false;
                    resolve();
                };
                utter.onerror = () => {
                    speaking = false;
                    resolve();
                };
                window.speechSynthesis.speak(utter);
            } else {
                resolve();
            }
        });
    }

    document.getElementById('startBtn').onclick = () => {
        if (keepListening) return; // Prevent double start
        keepListening = true;
        document.getElementById('stopBtn').disabled = false;
        listenLoop();
    };

    document.getElementById('stopBtn').onclick = () => {
        keepListening = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('startBtn').textContent = 'Start Listening (Server)';
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
        }
    };

    // Initialize stop button as disabled
    document.getElementById('stopBtn').disabled = true;
</script>
</body>

</html>